<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OIKOS Analytics Portal</title>
    <link rel="icon" type="image/png" href="https://oikos.com.co/wp-content/uploads/2021/01/cropped-Favicon-Oikos-32x32.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@600;800&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary-blue: #004a99; --deep-blue: #003366; --accent-cyan: #00d2ff; --text-gray: #64748b; --caledonia-red: #9C182F; }
        
        body, html { 
            font-family: 'DM Sans', sans-serif; 
            background: linear-gradient(135deg, #f0f4ff 0%, #e8ecf9 100%); 
            height: 100%; width: 100%; display: flex; align-items: center; justify-content: center; 
            position: relative; overflow: hidden; 
        }

        .circle-decoration { position: absolute; border-radius: 50%; opacity: 0.15; z-index: 0; filter: blur(50px); }
        .c1 { width: 300px; height: 300px; background: var(--primary-blue); top: -100px; left: -100px; animation: float 10s infinite; }
        .c2 { width: 400px; height: 400px; background: var(--accent-cyan); bottom: -150px; right: -150px; animation: float 12s infinite reverse; }
        @keyframes float { 0%, 100% { transform: translate(0,0); } 50% { transform: translate(20px, 20px); } }

        .container { 
            display: flex; background: white; border-radius: 28px; 
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.1); 
            max-width: 1000px; width: 92%; min-height: 600px;
            position: relative; z-index: 1; overflow: hidden;
            animation: slideUp 0.8s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .login-section { flex: 1.2; padding: 50px 60px; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .brand-name { font-family: 'Outfit', sans-serif; font-size: 32px; font-weight: 800; color: var(--primary-blue); margin-bottom: 40px; letter-spacing: -1px; }
        h2 { font-family: 'Outfit', sans-serif; font-size: 26px; color: #1e293b; margin-bottom: 12px; }
        .instruction { font-size: 13px; color: var(--text-gray); margin-bottom: 25px; line-height: 1.5; }

        .input-wrapper { display: flex; align-items: center; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 14px; transition: 0.3s; margin-bottom: 15px; }
        .input-wrapper input { flex: 1; padding: 18px; border: none; background: transparent; outline: none; font-size: 15px; color: #1e293b; }

        .btn-request { width: 100%; padding: 12px; background: white; color: var(--primary-blue); border: 2px solid var(--primary-blue); border-radius: 12px; font-weight: 700; cursor: pointer; margin-bottom: 15px; font-size: 12px; transition: 0.3s; }
        .btn-request:hover { background: #f0f7ff; }

        .main-button { width: 100%; padding: 18px; background: var(--primary-blue); color: white; border: none; border-radius: 14px; font-weight: 700; font-family: 'Outfit', sans-serif; cursor: pointer; transition: 0.3s; box-shadow: 0 10px 25px rgba(0, 74, 153, 0.2); margin-bottom: 12px; }
        .main-button:hover { background: var(--deep-blue); transform: translateY(-2px); }

        .main-button.caledonia { background: var(--caledonia-red); box-shadow: 0 10px 25px rgba(156, 24, 47, 0.2); }
        .main-button.caledonia:hover { background: #7a1325; }

        .btn-logout {
            width: 100%;
            padding: 10px 20px;
            background: white;
            color: #64748b;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            transition: 0.3s;
            font-size: 12px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .btn-logout:hover {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.15);
        }

        .welcome-section { flex: 1; background: linear-gradient(150deg, var(--primary-blue) 0%, var(--deep-blue) 100%); padding: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: white; }
        .welcome-section h1 { font-family: 'Outfit', sans-serif; font-size: 44px; margin-bottom: 20px; }
        .welcome-section p { font-size: 15px; opacity: 0.8; line-height: 1.6; max-width: 280px; }

        /* BI CONTAINER */
        #bi-container { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100vw; height: 100vh; 
            z-index: 99999; 
            background: white; 
        }

        /* HOME BUTTON */
        #btn-home {
            position: absolute;
            bottom: 2px;
            right: 2px;
            z-index: 100001;
            padding: 9px 15px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 7px;
            font-weight: 700;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 3px 10px rgba(0, 74, 153, 0.5);
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 7px;
            width: 180px;
        }
        #btn-home:hover {
            background: var(--deep-blue);
            transform: translateY(-2px);
            box-shadow: 0 5px 14px rgba(0, 74, 153, 0.6);
        }
        #btn-home svg { width: 17px; height: 17px; fill: white; }

        /* PDF BUTTON - CAMUFLADO, aparece solo al hover */
        #btn-pdf {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 100001;
            padding: 10px 16px;
            background: rgba(220, 38, 38, 0.92);
            color: white;
            border: none;
            border-radius: 9px;
            font-weight: 700;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 7px;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.35);
            /* CAMUFLADO: invisible por defecto */
            opacity: 0;
            pointer-events: none;
            transform: translateY(-6px);
            transition: opacity 0.35s ease, transform 0.35s ease;
        }
        #btn-pdf svg { width: 15px; height: 15px; fill: white; flex-shrink: 0; }
        #btn-pdf.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        #btn-pdf:hover {
            background: rgba(185, 28, 28, 0.97);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.5);
        }

        /* Zona de detecci贸n de hover (cubre toda la esquina superior izquierda) */
        #pdf-hover-zone {
            position: absolute;
            top: 0;
            left: 0;
            width: 200px;
            height: 80px;
            z-index: 100000;
            background: transparent;
        }

        /* Estado del PDF button mientras descarga */
        #btn-pdf.loading {
            background: rgba(100, 116, 139, 0.9);
            cursor: wait;
            pointer-events: none;
        }

        #shield-top-right { 
            position: absolute;
            top: 0; 
            right: 0; 
            width: 180px; 
            height: 55px;
            z-index: 100000;
            background: rgba(255, 255, 255, 0.01);
            cursor: pointer;
        } 
        #shield-bottom-right { 
            position: absolute;
            bottom: 0; 
            right: 0; 
            width: 440px; 
            height: 42px;
            z-index: 100000;
            background: rgba(255, 255, 255, 0.01);
            cursor: pointer;
        }
        #shield-home-extra {
            position: absolute;
            bottom: 0;
            right: 185px;
            width: 250px;
            height: 38px;
            z-index: 100000;
            background: rgba(255, 255, 255, 0.01);
            cursor: pointer;
        }

        iframe { width: 100%; height: 100%; border: none; display: block; }
        #status-msg { margin-top: 15px; font-size: 12px; text-align: center; font-weight: 600; }

        @media (max-width: 768px) {
            .btn-logout { font-size: 11px; padding: 8px 16px; }
            #btn-home { padding: 8px 12px; font-size: 12px; width: 150px; }
            #btn-pdf { font-size: 11px; padding: 8px 12px; }
        }
    </style>
</head>
<body>
    <div class="circle-decoration c1"></div>
    <div class="circle-decoration c2"></div>

    <div class="container" id="login-ui">
        <div class="login-section">
            <div class="brand-name">OIKOS</div>
            <h2>Acceso al Portal</h2>
            <p class="instruction">Introduce tu correo y clave. Si ya ingresaste hoy, tu sesi贸n estar谩 activa por 12 horas.</p>
            
            <div class="input-wrapper">
                <input type="email" id="email" placeholder="ejemplo@oikos.com.co" spellcheck="false">
            </div>
            
            <button class="btn-request" onclick="requestToken()">VALIDAR USUARIO</button>

            <div class="input-wrapper">
                <input type="text" id="token" placeholder="Clave Alfanum茅rica" maxlength="6">
            </div>
            
            <button class="main-button" onclick="verifyToken()">INGRESAR AL SISTEMA</button>
            <div id="status-msg"></div>
        </div>
        <div class="welcome-section">
            <h1>Analytics</h1>
            <p>Grupo Empresarial OIKOS S.A.S</p>
        </div>
    </div>

    <div id="bi-container">
        <!-- Bot贸n PDF camuflado (esquina superior izquierda) -->
        <div id="pdf-hover-zone"></div>
        <button id="btn-pdf" onclick="descargarPDF()">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/>
            </svg>
            Descargar PDF
        </button>

        <!-- Bot贸n HOME -->
        <button id="btn-home" onclick="volverHome()">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
            HOME
        </button>

        <!-- Shields de seguridad -->
        <div id="shield-top-right" onclick="securityReset()"></div>
        <div id="shield-bottom-right" onclick="securityReset()"></div>
        <div id="shield-home-extra" onclick="securityReset()"></div>

        <iframe id="bi-frame" src=""></iframe>
    </div>

    <script>
        // ============================================================
        // CONFIGURACIN DE CARPETAS PDF POR REPORTE
        // Mapea el nombre del reporte (tal como viene del Sheet "Link Bi")
        // con el ID de la carpeta de Drive correspondiente
        // ============================================================
        const PDF_FOLDER_MAP = {
            // Ajusta estas keys al NOMBRE EXACTO de tus reportes en la hoja "Link Bi"
            "OIKOS":       "18Bxx_ggnhur63fJlT7_cNGYUti2luXSW",
            "CALEDONIA":   "1Men8Pc2AjPWSPdGX920GSP5jUJ87Pwm-"
        };

        // ID de tu Apps Script principal (el que tiene action=getPdf)
        const API_URL = "https://script.google.com/macros/s/AKfycbzuYa205ymAfNU8Ysz2mJlC8u24POoHZMu2XJmxYe76W6J-sVTOL6jfsWUzt5b-3iD5nQ/exec";
        const REPO_URL = "https://analistadatos-oikos.github.io/Repositorios_Visuales_BI/";
        const SESSION_DURATION = 43200000;
        const REDIRECT_URL = "https://www.grupooikos.com/";

        // Reporte activo actualmente en el iframe
        let reporteActivo = null;

        // ============================================================
        // ANTI-INSPECCIN
        // ============================================================
        (function() {
            const noop = () => {};
            const methods = ['log', 'debug', 'info', 'warn', 'error', 'dir', 'dirxml', 'trace', 'profile', 'profileEnd', 'table', 'clear'];
            methods.forEach(method => { console[method] = noop; });
        })();

        let devtoolsDetected = false;

        setInterval(() => {
            const widthThreshold = window.outerWidth - window.innerWidth > 160;
            const heightThreshold = window.outerHeight - window.innerHeight > 160;
            if ((widthThreshold || heightThreshold) && !devtoolsDetected) {
                devtoolsDetected = true;
                window.location.replace(REDIRECT_URL);
            }
        }, 500);

        setInterval(() => {
            const start = new Date().getTime();
            debugger;
            const end = new Date().getTime();
            if (end - start > 100 && !devtoolsDetected) {
                devtoolsDetected = true;
                window.location.replace(REDIRECT_URL);
            }
        }, 1000);

        document.addEventListener('keydown', (e) => {
            if (
                e.key === 'F12' || 
                (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                (e.ctrlKey && e.shiftKey && e.key === 'C') ||
                (e.ctrlKey && e.shiftKey && e.key === 'J') ||
                (e.ctrlKey && e.key === 'U')
            ) {
                e.preventDefault();
                window.location.replace(REDIRECT_URL);
            }
        });

        // ============================================================
        // LGICA DEL BOTN PDF - HOVER ZONE
        // ============================================================
        const pdfHoverZone = document.getElementById('pdf-hover-zone');
        const btnPdf = document.getElementById('btn-pdf');
        let hideTimeout = null;

        function mostrarPdfBtn() {
            clearTimeout(hideTimeout);
            btnPdf.classList.add('visible');
        }

        function ocultarPdfBtn() {
            hideTimeout = setTimeout(() => {
                if (!btnPdf.matches(':hover')) {
                    btnPdf.classList.remove('visible');
                }
            }, 600);
        }

        pdfHoverZone.addEventListener('mouseenter', mostrarPdfBtn);
        pdfHoverZone.addEventListener('mouseleave', ocultarPdfBtn);
        btnPdf.addEventListener('mouseenter', mostrarPdfBtn);
        btnPdf.addEventListener('mouseleave', ocultarPdfBtn);

        // ============================================================
        // DESCARGA DE PDF
        // ============================================================
        async function descargarPDF() {
            if (!reporteActivo) return;

            // Buscar el folder ID seg煤n el reporte activo
            // Busca por coincidencia parcial (may煤sculas) para ser flexible
            const nombreUpper = reporteActivo.toUpperCase();
            let folderId = null;

            for (const key of Object.keys(PDF_FOLDER_MAP)) {
                if (nombreUpper.includes(key)) {
                    folderId = PDF_FOLDER_MAP[key];
                    break;
                }
            }

            if (!folderId) {
                alert("No se encontr贸 PDF para este reporte.");
                return;
            }

            // Mostrar estado de carga
            btnPdf.classList.add('loading');
            btnPdf.innerHTML = `
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="animation: spin 1s linear infinite;">
                    <path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8z"/>
                </svg>
                Descargando...
            `;

            // Agregar animaci贸n spin inline
            if (!document.getElementById('spin-style')) {
                const style = document.createElement('style');
                style.id = 'spin-style';
                style.textContent = '@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
                document.head.appendChild(style);
            }

            try {
                const res = await fetch(`${API_URL}?action=getPdf&folderId=${encodeURIComponent(folderId)}`);
                const data = await res.json();

                if (data.status === 'success' && data.downloadUrl) {
                    // Descarga directa usando un <a> temporal
                    const link = document.createElement('a');
                    link.href = data.downloadUrl;
                    link.download = data.fileName || 'reporte.pdf';
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert(data.message || "No se pudo obtener el PDF.");
                }
            } catch (err) {
                alert("Error al conectar con el servidor de archivos.");
            }

            // Restaurar bot贸n
            setTimeout(() => {
                btnPdf.classList.remove('loading');
                btnPdf.innerHTML = `
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/>
                    </svg>
                    Descargar PDF
                `;
            }, 2000);
        }

        // ============================================================
        // AUTENTICACIN Y SESIN
        // ============================================================
        function encodeUrl(url) {
            let step1 = btoa(url);
            let step2 = step1.split('').reverse().join('');
            let step3 = btoa(step2);
            return step3;
        }

        function decodeUrl(encoded) {
            let step1 = atob(encoded);
            let step2 = step1.split('').reverse().join('');
            let step3 = atob(step2);
            return step3;
        }

        window.onload = () => {
            const savedSession = JSON.parse(localStorage.getItem('oikos_auth_token'));
            if(savedSession) {
                const now = new Date().getTime();
                if(now - savedSession.time < SESSION_DURATION) {
                    showReportSelector(savedSession.reportes);
                }
            }
        };

        function salidaSegura() {
            localStorage.clear();
            sessionStorage.clear();
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            window.location.href = window.location.href.split('?')[0] + '?t=' + new Date().getTime();
        }

        function volverHome() {
            document.getElementById('bi-container').style.display = 'none';
            document.getElementById('bi-frame').src = '';
            document.getElementById('login-ui').style.display = 'flex';
            reporteActivo = null;
            
            const savedSession = JSON.parse(localStorage.getItem('oikos_auth_token'));
            if(savedSession && savedSession.reportes.length > 1) {
                showReportSelector(savedSession.reportes);
            } else {
                window.location.reload();
            }
        }

        function securityReset() {
            window.location.replace(REDIRECT_URL);
        }

        function setStatus(m, c = "#64748b") {
            const el = document.getElementById('status-msg');
            el.innerText = m; el.style.color = c;
        }

        async function requestToken() {
            const mail = document.getElementById('email').value;
            if(!mail.includes('@')) return setStatus("Correo no v谩lido", "#ef4444");
            setStatus("Enviando clave...", "#004a99");
            try {
                const res = await fetch(`${API_URL}?action=solicitar&correo=${encodeURIComponent(mail)}`);
                const data = await res.json();
                if(data.status === 'sent') setStatus("隆Clave enviada! V谩lida por 12h.", "#10b981");
                else setStatus(data.message, "#ef4444");
            } catch(e) { setStatus("Error de red", "#ef4444"); }
        }

        async function verifyToken() {
            const mail = document.getElementById('email').value;
            const tk = document.getElementById('token').value;
            if(!mail || !tk) return setStatus("Completa los datos", "#ef4444");
            setStatus("Verificando acceso...", "#004a99");
            try {
                const res = await fetch(`${API_URL}?action=validar&correo=${encodeURIComponent(mail)}&token=${encodeURIComponent(tk)}`);
                const data = await res.json();
                if(data.status === 'success') {
                    const reportesOfuscados = data.reportes.map(r => ({
                        nombre: r.nombre,
                        url: encodeUrl(r.url)
                    }));
                    localStorage.setItem('oikos_auth_token', JSON.stringify({
                        time: new Date().getTime(),
                        reportes: reportesOfuscados
                    }));
                    showReportSelector(reportesOfuscados);
                } else setStatus(data.message, "#ef4444");
            } catch(e) { setStatus("Falla de validaci贸n", "#ef4444"); }
        }

        function showReportSelector(reportes) {
            if(reportes.length === 1) {
                loadReport(reportes[0].url, reportes[0].nombre);
                return;
            }

            document.getElementById('login-ui').innerHTML = `
                <div class="login-section" style="text-align: center;">
                    <div class="brand-name">OIKOS Analytics</div>
                    <h2>Selecciona tu Reporte</h2>
                    <p class="instruction">Elige el dashboard que deseas visualizar</p>
                    <div id="buttons-container" style="display: flex; flex-direction: column; margin-top: 30px;">
                        ${reportes.map((r, idx) => `
                            <button class="main-button ${idx === 1 ? 'caledonia' : ''}" 
                                    onclick="loadReport('${r.url}', '${r.nombre}')">
                                ${r.nombre}
                            </button>
                        `).join('')}
                    </div>
                    <button class="btn-logout" onclick="salidaSegura()"> SALIDA SEGURA</button>
                </div>
                <div class="welcome-section">
                    <h1>Analytics</h1>
                    <p>Grupo Empresarial OIKOS S.A.S</p>
                </div>
            `;
            document.getElementById('login-ui').style.display = 'flex';
        }

        function loadReport(encodedUrl, nombre) {
            const realUrl = decodeUrl(encodedUrl);
            reporteActivo = nombre || '';  // Guardar qu茅 reporte est谩 activo
            document.getElementById('login-ui').style.display = 'none';
            document.getElementById('bi-container').style.display = 'block';
            document.getElementById('bi-frame').src = realUrl;
        }
    </script>
</body>
</html>
